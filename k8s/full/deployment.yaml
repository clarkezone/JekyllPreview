apiVersion: apps/v1
kind: Deployment
metadata:
  name: jekylldeployment
spec:
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: jekyllpreview
  template:
    metadata:
#      annotations:
#        prometheus.io/scrape: 'true'
#        prometheus.io/path: /metrics
#        prometheus.io/port: '8080'
    spec:
      initContainers:
      - name: deploy-init-jek
        image: registry.dev.clarkezone.dev/jekyllblogpreview:latest
        imagePullPolicy: Always
        command: ["./JekyllBlogPreview"]
        args: ["-initialclone", "true"]
        env:
          - name: JEKPREV_REPO
            value: https://gitea.homelab.clarkezone.dev/clarkezone/clarkezoneblog.git
          - name: JEKPREV_LOCALDIR
            value: /jekyll
        volumeMounts:
          - mountPath: /jekyll
            name: previewfiles
      containers:
      - name: deploy-jekyll
        image: registry.dev.clarkezone.dev/jekyllbuilder:arm
        command: ['sh', '-c', "--"]
        args: ["cd source;bundle install;bundle exec jekyll build JEKYLL_ENV=production;while true; do sleep 30000; done;"]
        volumeMounts:
          - mountPath: /src
            name: previewfiles
      - name: nginx-serve
        image: nginx:1.20-alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - mountPath: "/usr/share/nginx/html"
          subPath: "source/"
          name: previewfiles
      volumes:
        - name: previewfiles
          persistentVolumeClaim:
            claimName: jekyllblogpreview
