apiVersion: apps/v1
kind: Deployment
metadata:
  name: jekylldeployment
spec:
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: jekyllpreview
  template:
    metadata:
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/path: /metrics
        prometheus.io/port: '8080'
    spec:
      initContainers:
      - name: deploy-init-jek
        image: registry.dev.clarkezone.dev/jekyllblogpreview:latest
        imagePullPolicy: Always
        command: ["./JekyllBlogPreview"]
        args: ["-initialclone", "true"]
        env:
          - name: JEKPREV_REPO
            value: https://gitea.homelab.clarkezone.dev/clarkezone/testfoobar2.git
          - name: JEKPREV_LOCALDIR
            value: /jekyll
        volumeMounts:
          - mountPath: /jekyll
            name: previewfiles
      containers:
      - name: deploy-jekyll
        image: debian
        command: ['sh', '-c', "--"]
        args: ["while true; do sleep 30000; done;"]
        volumeMounts:
          - mountPath: /jekyll
            name: previewfiles
      volumes:
        - name: previewfiles
          persistentVolumeClaim:
            claimName: jekyllblogpreview
